[OSEv3:children]
masters
etcd
nodes
{% if deploy_cns | default('true') | bool %}
glusterfs
glusterfs_registry
{% endif %}

[OSEv3:vars]
debug_level=2

ansible_user=ec2-user
ansible_become=yes

openshift_deployment_type=openshift-enterprise
openshift_release=v3.10
openshift_master_api_port=443
openshift_master_console_port=443

{% if osm_cluster_network_cidr is defined %}
osm_cluster_network_cidr={{ osm_cluster_network_cidr }}
{% endif %}
{% if openshift_portal_net is defined %}
openshift_portal_net={{ openshift_portal_net }}
{% endif %}
os_sdn_network_plugin_name={{ os_sdn_network_plugin_name | default('redhat/openshift-ovs-multitenant') }}

openshift_master_cluster_method=native
openshift_node_local_quota_per_fsgroup=512Mi
# UPDATE USING VALUES FOUND IN awscli env vars or ~/playbooks/var/main.yaml
# SEE ALSO FILE ~/.ssh/config-< CLUSTERID >.< DNS_DOMAIN >-urls
openshift_master_default_subdomain={{ router_lb_default_subdomain | default('apps.change.me') }}
openshift_master_cluster_hostname={{ master_lb_dns | default('master.change.me') }}
openshift_master_cluster_public_hostname={{ master_lb_dns | default('master.change.me') }}

osm_use_cockpit=False

openshift_hostname_check=False
openshift_examples_modify_imagestreams=true

oreg_url=registry.access.redhat.com/openshift3/ose-${component}:${version}

{% if osm_project_request_message is defined %}
osm_project_request_message="{{ osm_project_request_message }}"
{% endif %}

{% if deploy_cns | default(true) | bool %}
# CNS Cnfiguration
# Container image to use for glusterfs pods
openshift_storage_glusterfs_image="registry.access.redhat.com/rhgs3/rhgs-server-rhel7:v3.10"

# Container image to use for glusterblock-provisioner pod
openshift_storage_glusterfs_block_image="registry.access.redhat.com/rhgs3/rhgs-gluster-block-prov-rhel7:v3.10"

# Container image to use for heketi pods
openshift_storage_glusterfs_heketi_image="registry.access.redhat.com/rhgs3/rhgs-volmanager-rhel7:v3.10"

# Container image to user for S3
openshift_storage_glusterfs_s3_image=registry.access.redhat.com/rhgs3/rhgs-gluster-s3-server-rhel7:v3.10"


# logging
{% if deploy_logging | default('True') | bool %}
openshift_logging_install_logging=True
openshift_logging_es_pvc_dynamic=True
openshift_logging_es_pvc_size={{ logging_volume_size }}
openshift_logging_es_cluster_size={{ ec2_count_infra }}
openshift_logging_es_pvc_storage_class_name='glusterfs-registry-block'
openshift_logging_kibana_nodeselector={"node-role.kubernetes.io/infra": "true"}
openshift_logging_curator_nodeselector={"node-role.kubernetes.io/infra": "true"}
openshift_logging_es_nodeselector={"node-role.kubernetes.io/infra": "true"}
{% else %}
openshift_logging_install_logging=True
{% endif %}

# metrics
{% if deploy_logging | default('True') | bool %}
openshift_metrics_install_metrics=True
openshift_metrics_storage_kind=dynamic
openshift_metrics_storage_volume_size={{ metrics_volume_size }}
openshift_metrics_cassandra_pvc_storage_class_name='glusterfs-registry-block'
openshift_metrics_hawkular_nodeselector={"node-role.kubernetes.io/infra": "true"}
openshift_metrics_cassandra_nodeselector={"node-role.kubernetes.io/infra": "true"}
openshift_metrics_heapster_nodeselector={"node-role.kubernetes.io/infra": "true"}
{% else %}
openshift_metrics_install_metrics=False
{% endif %}

# prometheus
{% if deploy_prometheus | default(True) | bool %}
openshift_hosted_prometheus_deploy=True
openshift_prometheus_storage_kind=dynamic
openshift_prometheus_storage_type=pvc
openshift_prometheus_storage_volume_size={{ prometheus_volume_size | default('25Gi') }}
openshift_prometheus_storage_class='glusterfs-registry-block'
{% else %}
openshift_hosted_prometheus_deploy=False
{% endif %}

# grafana
{% if deploy_grafana | default(true) | bool %}
openshift_grafana_state=present
openshift_grafana_node_exporter=True
openshift_grafana_storage_type=pvc
openshift_grafana_storage_class='glusterfs-registry-block'
openshift_grafana_prometheus_namespace='openshift-metrics'
openshift_grafana_prometheus_serviceaccount='prometheus'
openshift_grafana_prometheus_route='prometheus'
{% else %}
openshift_grafana_state=absent
{% endif %}


# Cluster 1
# Total Storage allocated (GB) = {{ ocs_infra_cluster_allocated_storage }}
# Total Storage available (GB) = {{ ocs_infra_cluster_usable_storage }}

{% if ec2_count_infra + ec2_count_node >= 6 %}
# Cluster 2
# Total Storage allocated (GB) = 0
# Total Storage available (GB) = {{ ocs_app_cluster_usable_storage }}


# CNS storage cluster
openshift_storage_glusterfs_namespace=app-storage
openshift_storage_glusterfs_storageclass=true
openshift_storage_glusterfs_storageclass_default=True
openshift_storage_glusterfs_block_deploy=True
openshift_storage_glusterfs_block_host_vol_create=false
openshift_storage_glusterfs_block_host_vol_size=100
openshift_storage_glusterfs_block_storageclass=false
openshift_storage_glusterfs_block_storageclass_default=false

# CNS storage for OpenShift infrastructure
openshift_storage_glusterfs_registry_namespace=infra-storage
openshift_storage_glusterfs_registry_storageclass=false
openshift_storage_glusterfs_registry_block_deploy=true
openshift_storage_glusterfs_registry_block_host_vol_create=true
openshift_storage_glusterfs_registry_block_host_vol_size={{ ocs_infra_cluster_allocated_storage }}
openshift_storage_glusterfs_registry_block_storageclass=true
openshift_storage_glusterfs_registry_block_storageclass_default=false
{% endif %}

{% else %}
# StorageClass if not CNS
openshift_storageclass_default=true
{% endif %}

openshift_hosted_router_selector='region=infra'
openshift_hosted_router_replicas={{ ec2_count_infra }}

# Registry
openshift_hosted_manage_registry=true
openshift_hosted_registry_storage_kind=object
openshift_hosted_registry_storage_provider=s3
openshift_hosted_registry_storage_s3_accesskey={{ s3_access_key }}
openshift_hosted_registry_storage_s3_secretkey={{ s3_secret_key }}
openshift_hosted_registry_storage_s3_bucket={{ clusterid }}.{{ dns_domain }}-registry
openshift_hosted_registry_storage_s3_region={{ aws_region }}
openshift_hosted_registry_storage_s3_chunksize=26214400
openshift_hosted_registry_storage_s3_rootdirectory=/registry
openshift_hosted_registry_pullthrough=true
openshift_hosted_registry_acceptschema2=true
openshift_hosted_registry_enforcequota=true
#openshift_hosted_registry_replicas={{ ec2_count_infra }}
openshift_hosted_registry_selector="node-role.kubernetes.io/infra=true"

# cloudprovider
openshift_cloudprovider_kind=aws
openshift_clusterid={{ clusterid }}
openshift_cloudprovider_aws_access_key={{ cpk_access_key }}
openshift_cloudprovider_aws_secret_key={{ cpk_secret_key }}

{% if router_cert is defined %}
####################
## custom certs
## Router
#####################
openshift_hosted_router_certificate={{ router_cert }}
{% endif %}

{% if master_cert is defined %}
# MASTER/API
openshift_master_overwrite_named_certificates=true
openshift_master_named_certificates={{ master_cert }}
{% endif %}
{% if openshift_master_identity_providers is defined %}
openshift_master_identity_providers={{ openshift_master_identity_providers }}
{% else %}
openshift_master_identity_providers=[{'name': 'htpasswd_auth', 'login': 'true', 'challenge': 'true', 'kind': 'HTPasswdPasswordIdentityProvider'}]
{% endif %}
{% if openshift_master_htpasswd_users is defined %}
openshift_master_htpasswd_users={{ openshift_master_htpasswd_users }}
{% else %}
# admin:changeme
openshift_master_htpasswd_users={'admin': '$apr1$VZeARzoK$zYM/4c82PKDeYmw6/RvOV/'}
{% endif %}
openshift_master_manage_htpasswd=true

openshift_enable_service_catalog={{ deploy_service_catalog | default('True') }}
template_service_broker_install={{ deploy_template_service_broker | default('True') }}

[masters]
{% for i in ec2master.results %}
{{ i.tagged_instances[0].private_dns_name }} openshift_node_labels="{'region': 'master'}"
{% endfor %}

[etcd]

[etcd:children]
masters

[nodes]
{% for i in ec2node.results -%}
{{ i.tagged_instances[0].private_dns_name }} openshift_node_labels="{'region': 'apps'}"
{% endfor -%}
{% for i in ec2infra.results -%}
{{ i.tagged_instances[0].private_dns_name }} openshift_node_labels="{'region': 'infra', 'zone': 'default'}"
{% endfor %}
[nodes:children]
masters

{% if deploy_cns |default('true') | bool and deploy_cns is defined %}
{% if ec2_count_infra + ec2_count_node >= 6 %}
[glusterfs]
{% for i in ec2node.results %}
{{ i.tagged_instances[0].private_dns_name }} glusterfs_zone={{ loop.index }} glusterfs_devices='[ "/dev/nvme3n1" ]'
{% endfor %}

[glusterfs_registry]
{% for i in ec2infra.results %}
{{ i.tagged_instances[0].private_dns_name }} glusterfs_zone={{ loop.index }} glusterfs_devices='["/dev/nvme3n1"]'
{% endfor %}
{% else %}

[glusterfs]
{% for i in ec2infra.results %}
{{ i.tagged_instances[0].private_dns_name }} glusterfs_zone={{ loop.index }} glusterfs_devices='[ "/dev/nvme3n1" ]'
{% endfor %}
{% endif %}
{% endif %}
